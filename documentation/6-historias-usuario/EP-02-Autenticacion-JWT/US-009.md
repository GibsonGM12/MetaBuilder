# US-009: Configurar middleware de autorización

## Información General

| Campo | Valor |
|-------|-------|
| **ID** | US-009 |
| **Título** | Configurar middleware de autorización |
| **Épica** | EP-02: Autenticación JWT |
| **Prioridad** | P0 (Crítica) |
| **Estimación** | 25 min |
| **Dependencias** | US-008 |

## Historia de Usuario

**Como** desarrollador backend,

**Quiero** proteger endpoints con dependencias FastAPI,

**Para** que solo usuarios autenticados accedan a recursos protegidos.

## Descripción

Crear dependencias get_current_user y get_current_admin para validar JWT y roles.

## Criterios de Aceptación

```gherkin
Scenario: Request sin token es rechazado
  Given que existe un endpoint protegido
  When envío request sin header Authorization
  Then recibo status 401 Unauthorized

Scenario: Request con token inválido es rechazado
  Given que existe un endpoint protegido
  When envío request con token inválido o expirado
  Then recibo status 401 Unauthorized

Scenario: Request con token válido es aceptado
  Given que existe un endpoint protegido
  And tengo un token JWT válido
  When envío request con header Authorization: Bearer {token}
  Then el request es procesado exitosamente

Scenario: Endpoint de admin rechaza usuarios normales
  Given que existe un endpoint que requiere rol Admin
  And tengo un token de usuario con rol User
  When envío request al endpoint de admin
  Then recibo status 403 Forbidden
```

## Notas Adicionales

- Usar HTTPBearer de FastAPI Security
- Implementar roles: Admin y User

## Historias de Usuario Relacionadas

- US-008: Crear endpoints de autenticación
- US-015: Crear MetadataRouter con endpoints REST
- US-023: Crear CrudRouter con endpoints REST
